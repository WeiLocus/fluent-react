name: Deploy pages

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. 安裝 pnpm
      - uses: pnpm/action-setup@v4
        with:
          version: 9

      # 2. 修改 Node 設定：啟用 pnpm 快取 (讓 build 更快)
      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      # 3. 安裝依賴：每個 slides 子資料夾各自安裝
      - name: Install dependencies for Conclusion
        run: pnpm install --frozen-lockfile
        working-directory: slides/conclusion

      - name: Install dependencies for React Alternatives
        run: pnpm install --frozen-lockfile
        working-directory: slides/react-alternatives

      - name: Install dependencies for React Server Components
        run: pnpm install --frozen-lockfile
        working-directory: slides/react-server-components

      # 4. Build 步驟：把原本的 nr (ni run) 改成 pnpm run 或是直接 slidev

      - name: Build Conclusion
        run: pnpm slidev build slides/conclusion/slides.md --base /${{github.event.repository.name}}/conclusion/ --out dist/conclusion

      - name: Build React Alternatives
        run: pnpm slidev build slides/react-alternatives/slides.md --base /${{github.event.repository.name}}/react-alternatives/ --out dist/react-alternatives

      - name: Build React Server Components
        run: pnpm slidev build slides/react-server-components/slides.md --base /${{github.event.repository.name}}/react-server-components/ --out dist/react-server-components

      # 5. 建立首頁 index.html，方便連到各個簡報
      - name: Create Index Page
        run: |
          echo '<!DOCTYPE html><html><head><title>My Slides</title></head><body>' > dist/index.html
          echo '<h1>My Presentations</h1><ul>' >> dist/index.html
          echo '<li><a href="./conclusion/">Conclusion</a></li>' >> dist/index.html
          echo '<li><a href="./react-alternatives/">React Alternatives</a></li>' >> dist/index.html
          echo '<li><a href="./react-server-components/">React Server Components</a></li>' >> dist/index.html
          echo '</ul></body></html>' >> dist/index.html

      # ---------------------------------------------------------
      # 6. 設定 GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # 7. 上傳 dist 目錄
      - uses: actions/upload-pages-artifact@v3
        with:
          # 上傳包含所有子資料夾的 dist 目錄
          path: dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
